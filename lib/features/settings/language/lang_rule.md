# 國際化開發規範

## 📋 專案概述

本文件定義了 PM25 空氣品質監測應用程式的國際化開發規範，遵循 TDD 測試驅動開發原則，確保多語言支援的完整性和一致性。

**核心開發原則：**
- **需求分析階段**：充分理解多語言需求，分析支援語言範圍和地區格式要求
- **設計階段**：選擇最簡單的解決方案來滿足多語言需求，避免過度設計
- **行為驅動開發**：先理解國際化功能需求與規格，再進行功能開發
- **程式碼保持 DRY 原則**：統一管理翻譯資源和語言切換邏輯
- **使用 Provider 進行狀態管理**：管理語言設定和切換狀態
- **靈活選擇 UI 框架**：支援 Material Design 和 Cupertino 的國際化需求
- **會依據反饋持續更新設計**：根據使用者反饋優化多語言體驗

## 🛠️ 技術架構

### 核心套件依賴
- **flutter_localizations**: Flutter 官方本地化支援
- **intl**: 國際化工具包，提供日期、數字格式化
- **shared_preferences**: 本地儲存語言偏好設定
- **provider**: 狀態管理語言切換

### 架構設計原則
- **分離關注點**：將國際化邏輯與業務邏輯分離
- **統一管理**：集中管理所有翻譯資源
- **動態切換**：支援運行時語言切換
- **Fallback 機制**：確保翻譯缺失時的優雅降級
- **效能優化**：避免不必要的重建和資源載入

## 🔄 開發流程規範

### 完整開發流程
1. **需求分析階段**
   - 確定支援的語言清單和地區格式
   - 分析不同語言的文字長度和佈局需求
   - 評估 RTL（右到左）語言支援需求
   - 制定翻譯資源管理策略

2. **設計階段**
   - 設計統一的翻譯資源結構
   - 規劃語言切換的使用者體驗
   - 設計 Fallback 機制和錯誤處理
   - 規劃測試策略和驗證方法

3. **測試設計階段**
   - 設計國際化單元測試
   - 撰寫語言切換的 Widget 測試
   - 規劃多語言整合測試
   - 設計 RTL 語言佈局測試

4. **編碼實現階段**
   - 遵循 BDD 原則，依照需求與規格實現功能
   - 建立統一的翻譯資源管理系統
   - 實現語言切換的 Provider 狀態管理
   - 確保程式碼符合 DRY 原則

5. **測試驗證階段**
   - 執行所有國際化相關測試
   - 驗證不同語言的 UI 佈局
   - 測試語言切換的流暢性
   - 驗證 Fallback 機制的正確性

6. **部署和維護階段**
   - 部署多語言版本進行驗證
   - 收集不同語言使用者的反饋
   - 持續優化翻譯品質和用戶體驗
   - 監控國際化功能的穩定性

## 🏗️ 架構設計規範

### 專案結構
```
lib/
├── core/
│   ├── constants/
│   │   └── language/           # 語言常數定義
│   │       ├── en.json        # 英文翻譯資源
│   │       └── zh.json        # 中文翻譯資源
│   └── services/
│       └── language_service.dart  # 語言服務
├── features/
│   └── settings/
│       └── language/          # 語言設定功能
│           ├── language_provider.dart
│           └── language_repository.dart
└── l10n/                      # 本地化資源
    ├── app_en.arb
    ├── app_zh.arb
    └── app_zh_TW.arb
```

### 命名規範
- **翻譯檔案**: `app_{locale}.arb` (例: `app_en.arb`, `app_zh.arb`)
- **語言常數**: `LANGUAGE_{LOCALE}` (例: `LANGUAGE_EN`, `LANGUAGE_ZH`)
- **Provider 類別**: `{Feature}Provider` (例: `LanguageProvider`)
- **服務類別**: `{Feature}Service` (例: `LanguageService`)

## 🔄 狀態管理規範

### Provider 使用原則
- 使用 `ChangeNotifierProvider` 管理語言狀態
- 避免在 build 方法中建立 Provider
- 使用 `Consumer` 或 `context.watch<LanguageProvider>()` 監聽語言變化
- 使用 `context.read<LanguageProvider>()` 呼叫語言切換方法

### 語言狀態管理結構
- **當前語言**: 儲存使用者選擇的語言
- **系統語言**: 儲存系統預設語言
- **支援語言清單**: 定義應用程式支援的語言
- **語言載入狀態**: 管理語言資源載入狀態

## 🎨 UI/UX 設計規範

### 語言切換介面設計
- **位置**: 設定頁面中的語言選項
- **樣式**: 使用 iOS 風格的選擇器或列表
- **即時預覽**: 切換語言時即時更新 UI
- **確認機制**: 重要設定變更需要確認

### 多語言佈局適配
- **文字長度**: 考慮不同語言文字長度差異
- **RTL 支援**: 支援從右到左的語言佈局
- **字體大小**: 確保不同語言的可讀性
- **圖示適配**: 考慮文化差異的圖示使用

## 📝 翻譯資源管理規範

### ARB 檔案結構
- **模板檔案**: 使用英文作為模板語言
- **命名規範**: 使用有意義的 key 名稱
- **參數化**: 支援動態參數和格式化
- **複數處理**: 正確處理不同語言的複數形式
- **選擇語句**: 支援條件性翻譯

### 翻譯品質控制
- **一致性**: 確保相同概念使用一致的翻譯
- **上下文**: 考慮翻譯的上下文環境
- **文化適配**: 考慮不同文化的表達習慣
- **專業術語**: 使用準確的專業術語翻譯

## 🧪 測試規範

### 測試策略
- **單元測試**: 測試語言切換邏輯和翻譯載入
- **Widget 測試**: 測試多語言 UI 組件渲染
- **整合測試**: 測試完整的多語言功能流程
- **視覺回歸測試**: 確保不同語言的 UI 一致性

### 測試覆蓋範圍
- **語言切換功能**: 驗證語言切換的正確性
- **翻譯完整性**: 確保所有 key 都有對應翻譯
- **Fallback 機制**: 測試翻譯缺失時的處理
- **格式化功能**: 測試日期、數字等格式化
- **RTL 佈局**: 測試從右到左語言的佈局

### 測試資料管理
- **模擬翻譯**: 使用測試用的翻譯資料
- **邊界測試**: 測試極端情況和錯誤處理
- **效能測試**: 測試語言切換的效能影響
- **相容性測試**: 測試不同裝置的相容性

## 🔒 安全性規範

### 翻譯資源安全
- **輸入驗證**: 驗證翻譯內容的安全性
- **XSS 防護**: 防止翻譯內容中的惡意腳本
- **內容過濾**: 過濾不當的翻譯內容
- **權限控制**: 控制翻譯資源的存取權限

### 資料保護
- **敏感資訊**: 避免在翻譯中暴露敏感資訊
- **隱私保護**: 確保語言偏好設定的隱私保護
- **資料加密**: 對重要的語言設定進行加密
- **安全傳輸**: 確保翻譯資源的安全傳輸

## 📱 效能優化

### 載入優化
- **延遲載入**: 按需載入語言資源
- **快取機制**: 快取已載入的翻譯資源
- **壓縮優化**: 壓縮翻譯資源檔案大小
- **預載入**: 預載入常用語言資源

### 記憶體管理
- **資源釋放**: 及時釋放不使用的語言資源
- **記憶體監控**: 監控語言切換的記憶體使用
- **垃圾回收**: 優化垃圾回收機制
- **記憶體洩漏**: 防止語言切換的記憶體洩漏

## 🚀 部署規範

### 環境配置
- **開發環境**: 支援所有語言的開發測試
- **測試環境**: 模擬不同語言環境的測試
- **生產環境**: 確保多語言版本的穩定部署
- **回滾機制**: 支援語言更新的回滾

### 版本控制
- **翻譯版本**: 管理翻譯資源的版本控制
- **相容性**: 確保新舊版本的相容性
- **更新機制**: 支援翻譯資源的動態更新
- **回滾策略**: 制定翻譯更新的回滾策略

## 🔄 問題解決與迭代優化

### 問題解決
- **翻譯缺失**: 建立翻譯缺失的檢測和修復機制
- **佈局問題**: 解決不同語言的佈局適配問題
- **效能問題**: 優化語言切換的效能瓶頸
- **相容性問題**: 解決不同裝置的相容性問題

### 迭代優化
- **使用者反饋**: 收集多語言使用者的反饋
- **翻譯品質**: 持續改善翻譯品質和準確性
- **使用者體驗**: 優化語言切換的使用者體驗
- **功能擴展**: 根據需求擴展支援的語言種類

## 📋 開發檢查清單

### 需求分析階段
- [ ] 確定支援的語言清單
- [ ] 分析不同語言的佈局需求
- [ ] 評估 RTL 語言支援需求
- [ ] 制定翻譯資源管理策略

### 設計階段
- [ ] 設計翻譯資源結構
- [ ] 規劃語言切換體驗
- [ ] 設計 Fallback 機制
- [ ] 規劃測試策略

### 測試設計階段
- [ ] 設計國際化單元測試
- [ ] 撰寫語言切換 Widget 測試
- [ ] 規劃多語言整合測試
- [ ] 設計 RTL 佈局測試

### 編碼實現階段
- [ ] 遵循 TDD 原則開發
- [ ] 建立翻譯資源管理系統
- [ ] 實現語言切換狀態管理
- [ ] 確保程式碼符合 DRY 原則

### 測試驗證階段
- [ ] 執行所有國際化測試
- [ ] 驗證多語言 UI 佈局
- [ ] 測試語言切換流暢性
- [ ] 驗證 Fallback 機制

### 部署和維護階段
- [ ] 部署多語言版本
- [ ] 收集使用者反饋
- [ ] 持續優化翻譯品質
- [ ] 監控國際化功能穩定性

## 🔄 國際化開發流程

### 階段性開發流程
1. **架構設置階段**
   - 加入語言支援套件依賴
   - 設置 localization delegates 與支援語言清單
   - 處理 locale resolution 邏輯
   - 確保 App 能處理 locale 變動與支援多語文本及格式

2. **翻譯檔案準備階段**
   - 建立 .arb 模板檔案與各語言 .arb 檔案
   - 處理 placeholder、複數、選擇語句等語法
   - 實際撰寫翻譯文字與格式化資源
   - 確保翻譯品質和一致性

3. **生成功能階段**
   - 使用 gen_l10n 或 intl 工具生成 Dart 類別
   - 載入翻譯函式和本地化資源
   - 將翻譯資源轉為程式可用形式
   - 確認 localizationsDelegates 和 supportedLocales 設置

4. **UI 使用階段**
   - 透過 AppLocalizations.of(context) 取得翻譯字串
   - 處理日期、時間、數字格式化
   - 處理文字方向性 (RTL / LTR) 支援
   - 在 UI 中正確顯示多語言內容

5. **覆寫與切換機制階段**
   - 提供用戶選擇語言的介面
   - 儲存語言偏好設定到本地儲存
   - 使用 localeResolutionCallback 處理系統語言匹配
   - 支援 Localizations.override 局部覆寫

6. **Fallback 處理階段**
   - 處理翻譯缺失時的 fallback 機制
   - 處理系統 locale 不支援時的降級處理
   - 確保應用程式在各種情況下都能正常運作
   - 提供優雅的錯誤處理和用戶提示

7. **測試與維護階段**
   - 檢查所有翻譯 key 的完整性
   - 測試參數化字串與複數/選擇語句
   - 測試 RTL 語言和不同地區格式
   - 建立翻譯更新和新增語言的流程

8. **完成與發布階段**
   - 確認所有翻譯資源齊全
   - 進行本機與線上環境測試
   - 處理 locale 異常情況的測試
   - 完成 App 上架和釋出

## 📊 開發流程圖

### 主要開發流程
```
需求分析 → 架構設計 → 測試設計 → 編碼實現 → 測試驗證 → 部署維護
    ↓         ↓         ↓         ↓         ↓         ↓
語言清單   翻譯結構   國際化測試  翻譯管理   多語言驗證  使用者反饋
    ↓         ↓         ↓         ↓         ↓         ↓
佈局需求   切換體驗   Widget測試  狀態管理   UI佈局    品質優化
    ↓         ↓         ↓         ↓         ↓         ↓
RTL支援   Fallback   整合測試   效能優化   切換流暢   功能擴展
```

### 技術實作流程
```
套件依賴 → 配置設定 → 翻譯資源 → 生成工具 → UI整合 → 狀態管理
    ↓         ↓         ↓         ↓         ↓         ↓
flutter_    l10n.yaml  .arb檔案   gen_l10n   AppLocal   Provider
localizations          翻譯內容   工具生成    izations   狀態管理
    ↓         ↓         ↓         ↓         ↓         ↓
intl工具包  支援語言   參數化     Dart類別   格式化    語言切換
    ↓         ↓         ↓         ↓         ↓         ↓
shared_     locale    複數處理   本地化      RTL支援   快取機制
preferences 解析      選擇語句   資源       佈局      效能優化
```

## 🎯 品質保證流程

### 測試驗證流程
```
單元測試 → Widget測試 → 整合測試 → 視覺回歸測試 → 使用者驗收測試
    ↓         ↓         ↓           ↓             ↓
語言切換   多語言UI   完整流程     佈局一致性     使用者體驗
邏輯測試   組件渲染   功能測試     視覺驗證       滿意度測試
    ↓         ↓         ↓           ↓             ↓
翻譯載入   格式化      RTL佈局     不同裝置       反饋收集
邊界測試   錯誤處理    效能測試     相容性測試     持續改進
```

### 部署發布流程
```
開發環境 → 測試環境 → 預生產環境 → 生產環境 → 監控維護
    ↓         ↓         ↓           ↓         ↓
功能開發   功能測試   完整驗證     正式發布   效能監控
    ↓         ↓         ↓           ↓         ↓
翻譯測試   多語言     使用者驗收   版本管理   錯誤追蹤
    ↓         ↓         ↓           ↓         ↓
佈局測試   效能測試   安全檢查     回滾機制   持續優化
```

## 📚 相關規範文件

- **主要開發規範**: [RULES.md](../../../.cursor/RULES.md)
- **iOS 設計規範**: [ui/ios-style-rule.mdc](../../../.cursor/rules/ui/ios-style-rule.mdc)
- **日誌系統規範**: [log/log-rule.mdc](../../../.cursor/rules/log/log-rule.mdc)
- **主題設定規範**: [theme/darkmode.md](../../theme/darkmode.md)

---

**最後更新**: 2025年09月  
**版本**: 2.0.0  
**適用範圍**: PM25 應用程式國際化開發規範

